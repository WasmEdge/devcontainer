---
name: ubuntu

on:
  pull_request:
    branches: [main]
    paths:
      - 'docker-bake.ubuntu.hcl'
      - 'Dockerfile.ubuntu*'
      - 'scripts/**'

permissions: {}

jobs:
  bake:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            targets: focal,jammy,noble,cuda
            host_runner: ubuntu-latest
          - arch: aarch64
            targets: aarch64
            host_runner: ubuntu-24.04-arm

    name: Ubuntu (${{ matrix.arch }})
    runs-on: ${{ matrix.host_runner }}

    steps:
      - if: ${{ github.event_name != 'pull_request' }}
        name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Bake and Push
        uses: docker/bake-action@v6
        with:
          push: ${{ github.event_name != 'pull_request' }}
          files: docker-bake.ubuntu.hcl
          targets: ${{ matrix.targets }}
